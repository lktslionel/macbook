---
- name: install zsh
  homebrew: name=zsh state=latest
  when: ansible_os_family == 'Darwin'
  tags: zsh

- name: add zsh to list of shells
  lineinfile: >
    backup=yes
    dest=/etc/shells
    regexp=^/usr/local/bin/zsh
    line=/usr/local/bin/zsh
  when: ansible_os_family == 'Darwin'
  become: true
  tags: zsh

- name: change to zsh (Mac)
  shell: chsh -s /usr/local/bin/zsh {{ ansible_env.USER }}
  when: ansible_os_family == 'Darwin'
  tags: zsh

- name: change to zsh (Ubuntu)
  shell: chsh -s /usr/bin/zsh {{ ansible_env.USER }}
  when: ansible_os_family == 'Ubuntu'

- name: install oh-my-zsh
  git: repo=https://github.com/robbyrussell/oh-my-zsh.git
       dest=~/.oh-my-zsh
       recursive=yes
  tags: zsh

- name: Ensure oh-my-zsh-custom directory
  file:
    name: ~/.oh-my-zsh-custom
    state: directory
  tags: zsh

- name: add zshrc file
  template: 
    src: zshrc.j2
    dest: ~/.zshrc
  tags: zsh

- name: Install shell integration for iterm2
  command: bash -c "curl -L https://iterm2.com/misc/install_shell_integration.sh | bash"
  tags: zsh

- name: Fix shell integration conflicts
  lineinfile: 
    dest: ~/.iterm2_shell_integration.zsh
    regexp: "^ITERM2_PRECMD_PS1" 
    insertafter: "^    ITERM_SHELL_INTEGRATION_INSTALLED" 
    line: 'ITERM2_PRECMD_PS1="$PS1"'
  tags: zsh